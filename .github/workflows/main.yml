name: SSH over Ngrok

on:
  workflow_dispatch:   # Manuel tetiklemek iÃ§in
  push:                # Push ile de Ã§alÄ±ÅŸtÄ±rmak istersen

jobs:
  ssh-ngrok:
    runs-on: self-hosted   # Self-hosted runner olmalÄ±, aksi halde job VM biterse tÃ¼nel kapanÄ±r

    steps:
    - name: Update apt
      run: sudo apt-get update -qq

    - name: Install SSH server
      run: |
        sudo apt-get install -y openssh-server
        echo "root:123456" | sudo chpasswd
        sudo mkdir -p /var/run/sshd
        echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
        echo "PasswordAuthentication yes" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh start

    - name: Install Ngrok
      run: |
        curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update -qq
        sudo apt install -y ngrok jq

    - name: Run Ngrok Tunnel and Keep Alive
      run: |
        NGROK_TOKEN="2yBP8xeJ21kecv1rmpPXvO9YA0V_4vCVix96ZGJwravydUxMc"
        # Sonsuz dÃ¶ngÃ¼ ile ngrok'u sÃ¼rekli Ã§alÄ±ÅŸtÄ±r
        while true; do
          echo "ðŸ”„ Ngrok tÃ¼neli baÅŸlatÄ±lÄ±yor..."
          nohup ngrok tcp 22 --authtoken $NGROK_TOKEN > ngrok.log 2>&1 &
          sleep 10
          echo "ðŸ“œ Ngrok Log:"
          cat ngrok.log
          echo "ðŸ”— TÃ¼nel URLâ€™i:"
          curl http://localhost:4040/api/tunnels
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          HOST_PORT=$(echo $NGROK_URL | sed 's/tcp:\/\///' | sed 's/:/ -p /')
          echo "ðŸ”‘ SSH BaÄŸlantÄ±sÄ± HazÄ±r:"
          echo "ssh root@$HOST_PORT"
          echo "Åžifre: 123456"
          sleep 300  # 5 dakikada bir tekrar kontrol ve yeniden baÅŸlatma
        done
